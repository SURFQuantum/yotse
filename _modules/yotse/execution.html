<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>yotse.execution &mdash; YOTSE  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            YOTSE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../yotse.html">Yotse Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Yotse Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">YOTSE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">yotse.execution</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for yotse.execution</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Defines classes and functions for the execution of your experiment.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">qcg.pilotjob.api.job</span> <span class="kn">import</span> <span class="n">Jobs</span>
<span class="kn">from</span> <span class="nn">qcg.pilotjob.api.manager</span> <span class="kn">import</span> <span class="n">LocalManager</span>

<span class="kn">from</span> <span class="nn">yotse.optimization.blackbox_algorithms</span> <span class="kn">import</span> <span class="n">BayesOpt</span>
<span class="kn">from</span> <span class="nn">yotse.optimization.blackbox_algorithms</span> <span class="kn">import</span> <span class="n">GAOpt</span>
<span class="kn">from</span> <span class="nn">yotse.optimization.generic_optimization</span> <span class="kn">import</span> <span class="n">GenericOptimization</span>
<span class="kn">from</span> <span class="nn">yotse.optimization.optimizer</span> <span class="kn">import</span> <span class="n">Optimizer</span>
<span class="kn">from</span> <span class="nn">yotse.optimization.whitebox_algorithms</span> <span class="kn">import</span> <span class="n">SciPyOpt</span>
<span class="kn">from</span> <span class="nn">yotse.pre</span> <span class="kn">import</span> <span class="n">Experiment</span>
<span class="kn">from</span> <span class="nn">yotse.pre</span> <span class="kn">import</span> <span class="n">OptimizationInfo</span>
<span class="kn">from</span> <span class="nn">yotse.pre</span> <span class="kn">import</span> <span class="n">set_basic_directory_structure_for_job</span>
<span class="kn">from</span> <span class="nn">yotse.utils.utils</span> <span class="kn">import</span> <span class="n">file_list_to_single_df</span>
<span class="kn">from</span> <span class="nn">yotse.utils.utils</span> <span class="kn">import</span> <span class="n">get_files_by_extension</span>


<div class="viewcode-block" id="Executor">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor">[docs]</a>
<span class="k">class</span> <span class="nc">Executor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A facilitator for running experiments and optimization algorithms.</span>

<span class="sd">    The `Executor` class coordinates the execution of experiments, manages the optimization process,</span>
<span class="sd">    and interfaces with the LocalManager for job submission. It supports both black-box and white-box</span>
<span class="sd">    optimization strategies, allowing for the exploration of various optimization algorithms.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment : Experiment</span>
<span class="sd">        The experiment object associated with the executor.</span>
<span class="sd">    blackbox_optimization : bool</span>
<span class="sd">        Flag indicating whether the optimization process is black-box or white-box.</span>
<span class="sd">    optimizer : Optimizer</span>
<span class="sd">        The optimizer object responsible for managing the optimization algorithm.</span>
<span class="sd">    aux_dir : str</span>
<span class="sd">        The auxiliary directory used during the optimization process.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment : Experiment</span>
<span class="sd">        The experiment object associated with the executor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Executor.__init__">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize `Executor` object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Experiment</span> <span class="o">=</span> <span class="n">experiment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blackbox_optimization</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">:</span> <span class="n">Optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_optimizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aux_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;--resume&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">cmdline_arguments</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">cmdline_arguments</span><span class="p">[</span><span class="s2">&quot;--resume&quot;</span><span class="p">],</span> <span class="nb">str</span>
            <span class="p">),</span> <span class="s2">&quot;--resume keyword must be passed a string describing the path to the aux directory.&quot;</span>
            <span class="c1"># if resuming the simulation, load state from file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_executor_state</span><span class="p">(</span>
                <span class="n">aux_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">cmdline_arguments</span><span class="p">[</span><span class="s2">&quot;--resume&quot;</span><span class="p">]</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Executor.next_optimization">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.next_optimization">[docs]</a>
    <span class="k">def</span> <span class="nf">next_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Switch to the next active optimization in the list.</span>

<span class="sd">        Deactivates the current active optimization and activates the next one in the list.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If there are multiple active optimizations or none at all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_optimizations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OptimizationInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">opt</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">opt_info_list</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">is_active</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_optimizations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">active_optimization</span> <span class="o">=</span> <span class="n">active_optimizations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">active_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">opt_info_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">active_optimization</span><span class="p">)</span>
            <span class="n">next_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">active_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">opt_info_list</span><span class="p">)</span>

            <span class="c1"># Deactivate the current optimization</span>
            <span class="n">active_optimization</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Activate the next optimization</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">opt_info_list</span><span class="p">[</span><span class="n">next_index</span><span class="p">]</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_optimizations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Multiple active optimization steps. Please set all but one to active=False&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No active optimization steps found.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_optimizer</span><span class="p">()</span></div>


<div class="viewcode-block" id="Executor.get_active_optimization">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.get_active_optimization">[docs]</a>
    <span class="k">def</span> <span class="nf">get_active_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the active optimization step.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        OptimizationInfo</span>
<span class="sd">            The active optimization step.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If there are multiple active optimization steps.</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If no active optimization steps are found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">active_optimizations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">opt</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">opt_info_list</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">is_active</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_optimizations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">active_optimizations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_optimizations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Multiple active optimization steps. Please set all but one to active=False&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No active optimization steps found.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Executor.generate_optimizer">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.generate_optimizer">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optimizer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the optimization algorithm for the run by translating information in the</span>
<span class="sd">        currently &#39;active&#39; optimization_info.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        optimization_alg : GenericOptimization</span>
<span class="sd">            Object of subclass of `:class:GenericOptimization`, the optimization algorithm to be used by this runner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optimization_alg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenericOptimization</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">opt_info_list</span><span class="p">:</span>
            <span class="n">opt_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_optimization</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">opt_info</span><span class="o">.</span><span class="n">blackbox_optimization</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blackbox_optimization</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># todo: moving refinement factors to params is also an option</span>
                <span class="c1"># ref_factors = [param.refinement_factor for param in experiment.parameters if param.is_active]</span>
                <span class="c1"># if None in ref_factors or len(ref_factors) != len([p for p in experiment.parameters if p.is_active]):</span>
                <span class="c1">#     raise ValueError(&quot;When using refinement factors they must be specified for all active parameters.&quot;)</span>

                <span class="c1"># Note: param_type could be subsumed into this maybe by giving &#39;step&#39;=1?</span>
                <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">param</span><span class="o">.</span><span class="n">constraints</span>
                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">parameters</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">is_active</span>
                <span class="p">]</span>
                <span class="c1"># check if there are no constraints</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">):</span>
                    <span class="n">constraints</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
                <span class="c1"># todo: add more tests that check what happens if only some constraints are None etc.</span>
                <span class="c1"># param_types = [int if param.param_type == &quot;discrete&quot; else float for param in experiment.parameters</span>
                <span class="c1">#                if param.is_active]</span>
                <span class="c1"># if len(set(param_types)) == 1:</span>
                <span class="c1">#     param_types = param_types[0]</span>
                <span class="c1"># todo: figure out what&#39;s nicer for user constraint or data_type? both seems redundant?</span>
                <span class="k">if</span> <span class="n">opt_info</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ga&quot;</span><span class="p">:</span>
                    <span class="n">optimization_alg</span> <span class="o">=</span> <span class="n">GAOpt</span><span class="p">(</span>
                        <span class="n">blackbox_optimization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">initial_data_points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_points</span><span class="p">,</span>
                        <span class="c1"># gene_type=param_types,</span>
                        <span class="n">gene_space</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                        <span class="o">**</span><span class="n">opt_info</span><span class="o">.</span><span class="n">opt_parameters</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">opt_info</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                    <span class="n">optimization_alg</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">opt_info</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;bayesopt&quot;</span><span class="p">:</span>
                    <span class="n">optimization_alg</span> <span class="o">=</span> <span class="n">BayesOpt</span><span class="p">(</span>
                        <span class="n">blackbox_optimization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">initial_data_points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_points</span><span class="p">,</span>
                        <span class="n">pbounds</span><span class="o">=</span><span class="p">{</span>
                            <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">(</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="p">)</span>  <span class="c1"># cast to int for bayesian opt, see comment in class</span>
                            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">parameters</span>
                        <span class="p">},</span>
                        <span class="o">**</span><span class="n">opt_info</span><span class="o">.</span><span class="n">opt_parameters</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unknown blackbox optimization algorithm: </span><span class="si">{</span><span class="n">opt_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># whitebox optimization</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blackbox_optimization</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># if opt_info.name.lower() == &quot;ga&quot;:</span>
                <span class="c1">#     optimization_alg = GAOpt(</span>
                <span class="c1">#         blackbox_optimization=False,</span>
                <span class="c1">#         fitness_func=opt_info.function,</span>
                <span class="c1">#         initial_data_points=self.experiment.data_points,</span>
                <span class="c1">#         # gene_type=param_types,</span>
                <span class="c1">#         gene_space=constraints,  # type: ignore</span>
                <span class="c1">#         **opt_info.opt_parameters,</span>
                <span class="c1">#     )</span>
                <span class="k">if</span> <span class="n">opt_info</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;scipy&quot;</span><span class="p">:</span>
                    <span class="n">optimization_alg</span> <span class="o">=</span> <span class="n">SciPyOpt</span><span class="p">(</span><span class="o">**</span><span class="n">opt_info</span><span class="o">.</span><span class="n">opt_parameters</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">opt_info</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                    <span class="n">optimization_alg</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unknown whitebox optimization algorithm: </span><span class="si">{</span><span class="n">opt_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">Optimizer</span><span class="p">(</span><span class="n">optimization_algorithm</span><span class="o">=</span><span class="n">optimization_alg</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span></div>


<div class="viewcode-block" id="Executor.run">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">step_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">evolutionary_point_generation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Submits jobs to the LocalManager, collects the output, creates new data</span>
<span class="sd">        points, and finishes the run.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        step_number : int (optional)</span>
<span class="sd">            Step number to submit to QCGPilot. Should be used for e.g. running different optimization steps.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        evolutionary_point_generation : bool (optional)</span>
<span class="sd">            Overwrite the type of construction to be used for the new points. If None the optimization</span>
<span class="sd">            algorithm determines whether the point creation is evolutionary or based on the best solution.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blackbox_optimization</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Starting default run of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (step</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">): submit, collect, create.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">step_number</span><span class="o">=</span><span class="n">step_number</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_points_based_on_optimization</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">evolutionary</span><span class="o">=</span><span class="n">evolutionary_point_generation</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_executor_state</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished run of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (step</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Starting run of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> using whitebox optimization </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_active_optimization</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">whitebox_submit</span><span class="p">()</span></div>


<div class="viewcode-block" id="Executor.pre_submission_setup_per_job">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.pre_submission_setup_per_job">[docs]</a>
    <span class="k">def</span> <span class="nf">pre_submission_setup_per_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">datapoint_item</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">step_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">job_number</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets up the basic directory structure for a job and returns the QCG- Pilot</span>
<span class="sd">        command line list for it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        datapoint_item : list</span>
<span class="sd">            Single item of data points for the job as a list.</span>
<span class="sd">        step_number : int</span>
<span class="sd">            The number of the step in the experiment.</span>
<span class="sd">        job_number : int</span>
<span class="sd">            The number of the job within the step.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        program_commandline : list</span>
<span class="sd">            The list of command line arguments for the QCG-Pilot job submission for the program.</span>
<span class="sd">        Note: Overwrite this function if you need other directory structure or pre-submission functionality.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">datapoint_item</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="p">)</span>  <span class="c1"># check item is not an array, which is not serializable</span>
        <span class="n">set_basic_directory_structure_for_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span> <span class="n">step_number</span><span class="p">,</span> <span class="n">job_number</span><span class="p">)</span>
        <span class="n">program_commandline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">qcgpilot_commandline</span><span class="p">(</span>
            <span class="n">datapoint_item</span><span class="o">=</span><span class="n">datapoint_item</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">program_commandline</span></div>


<div class="viewcode-block" id="Executor.pre_submission_analysis">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.pre_submission_analysis">[docs]</a>
    <span class="k">def</span> <span class="nf">pre_submission_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes any necessary steps before the analysis script and returns the QCG-</span>
<span class="sd">        Pilot command line list for it.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_commandline : list</span>
<span class="sd">            The list of command line arguments for the QCG-Pilot job submission for the program.</span>
<span class="sd">        Note: Overwrite this function if you need other directory structure or pre-submission functionality for your</span>
<span class="sd">        analysis script.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">analysis_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">analysis_commandline</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">source_directory</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">analysis_script</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">analysis_commandline</span></div>


<div class="viewcode-block" id="Executor.submit">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.submit">[docs]</a>
    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Submits jobs to the LocalManager.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        step_number : int, optional</span>
<span class="sd">            Step number to submit to QCGPilot. Should be used for e.g. running different optimization steps.</span>
<span class="sd">            Defaults to 0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        job_ids : list</span>
<span class="sd">            A list of job IDs submitted to the LocalManager.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">manager</span> <span class="o">=</span> <span class="n">LocalManager</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">qcg_cfg</span><span class="p">)</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">stdout_basename</span>
        <span class="n">instance_id</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">system_status</span><span class="p">()[</span><span class="s2">&quot;System&quot;</span><span class="p">][</span><span class="s2">&quot;InstanceId&quot;</span><span class="p">]</span>
        <span class="n">aux_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;.qcgpjm-service-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instance_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aux_dir</span> <span class="o">=</span> <span class="n">aux_dir</span>

        <span class="n">jobs</span> <span class="o">=</span> <span class="n">Jobs</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_points</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Can not submit jobs for Experiment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: No datapoints available.&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_points</span><span class="p">):</span>
            <span class="n">prog_cmdline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_submission_setup_per_job</span><span class="p">(</span>
                <span class="n">datapoint_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">step_number</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span> <span class="n">job_number</span><span class="o">=</span><span class="n">i</span>
            <span class="p">)</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                    <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">prog_cmdline</span><span class="p">,</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="n">stdout</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="n">stdout</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.err&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;wd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">job_args</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">analysis_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analysis_cmdline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_submission_analysis</span><span class="p">()</span>
            <span class="c1"># add analysis job with correct dependency</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;step</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">_analysis&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">analysis_cmdline</span><span class="p">,</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="n">stdout</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;step</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">_analysis.txt&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="n">stdout</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;step</span><span class="si">{</span><span class="n">step_number</span><span class="si">}</span><span class="s2">_analysis.err&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;wd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">current_step_directory</span><span class="p">,</span>
                    <span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="n">jobs</span><span class="o">.</span><span class="n">job_names</span><span class="p">(),</span>
                <span class="p">},</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">job_args</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">wait4</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">job_ids</span>  <span class="c1"># type: ignore[no-any-return]</span></div>


<div class="viewcode-block" id="Executor.whitebox_submit">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.whitebox_submit">[docs]</a>
    <span class="k">def</span> <span class="nf">whitebox_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the white-box optimization process.</span>

<span class="sd">        Currently, this does not use QCGPilotJob but runs locally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># todo: change this to run using QCQPilotJob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Executor.collect_data">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.collect_data">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collects data from output.csv (or the output of the scripts) and combines it</span>
<span class="sd">        into a dataframe which has as first column the associated cost and as the other</span>
<span class="sd">        columns the input parameters (order the same way is input to the experiment).</span>
<span class="sd">        The rows of the dataframe follow the same ordering as the jobs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : pandas.Dataframe</span>
<span class="sd">            Pandas dataframe containing the combined outputs of the individual jobs in the form above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">analysis_script</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># no analysis script: extract data from output files in job dirs and combine to single dataframe</span>
            <span class="n">output_directory_current_step</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">current_step_directory</span>
            <span class="p">)</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">output_extension</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">job_dir</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">output_directory_current_step</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">output_directory_current_step</span>
            <span class="p">]:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_files_by_extension</span><span class="p">(</span><span class="n">job_dir</span><span class="p">,</span> <span class="n">extension</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">file_list_to_single_df</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span>
            <span class="c1"># todo : This is unsorted, is that a problem? yes. sort this by job no.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># analysis script is given and will output file &#39;output.csv&#39; with format &#39;cost_fun param0 param1 ...&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">system_setup</span><span class="o">.</span><span class="n">current_step_directory</span><span class="p">,</span> <span class="s2">&quot;output.csv&quot;</span>
                <span class="p">),</span>
                <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="Executor.create_points_based_on_optimization">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.create_points_based_on_optimization">[docs]</a>
    <span class="k">def</span> <span class="nf">create_points_based_on_optimization</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies an optimization algorithm to process the collected data and create</span>
<span class="sd">        new data points from it which is then directly written into the experiments</span>
<span class="sd">        attributes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : pandas.Dataframe</span>
<span class="sd">            A pandas dataframe containing the collected data in the format cost_value init_param_1 ... init_param_n.</span>
<span class="sd">        evolutionary : bool , optional</span>
<span class="sd">            Overwrite the type of construction to be used for the new points. If evolutionary=None the optimization</span>
<span class="sd">            algorithm determines whether the point creation is evolutionary or based on the best solution.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">optimization_algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">evolutionary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">evolutionary</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">optimization_algorithm</span><span class="o">.</span><span class="n">can_create_points_evolutionary</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">update_blackbox_cost_data</span><span class="p">(</span>
                <span class="n">experiment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">optimization_algorithm</span><span class="o">.</span><span class="n">function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Optimization attempted to create new points without a cost function.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">construct_points</span><span class="p">(</span>
                <span class="n">experiment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span> <span class="n">evolutionary</span><span class="o">=</span><span class="n">evolutionary</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Executor.save_executor_state">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.save_executor_state">[docs]</a>
    <span class="k">def</span> <span class="nf">save_executor_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save state of the Executor to be able to resume later.&quot;&quot;&quot;</span>
        <span class="c1"># Note: maybe this should be optional, because not everything might be serializable, e.g. complex cost_functions</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_dir</span><span class="p">,</span> <span class="s2">&quot;yotse_state_save.pickle&quot;</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Latest state of yotse executor saved in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Executor.load_executor_state">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.Executor.load_executor_state">[docs]</a>
    <span class="k">def</span> <span class="nf">load_executor_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aux_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the state of the Executor to be able to resume.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aux_directory</span><span class="p">,</span> <span class="s2">&quot;yotse_state_save.pickle&quot;</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;State of yotse executor loaded from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No saved state file found in </span><span class="si">{</span><span class="n">aux_directory</span><span class="si">}</span><span class="s2">, when trying to resume workflow.&quot;</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CustomExecutor">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.CustomExecutor">[docs]</a>
<span class="k">class</span> <span class="nc">CustomExecutor</span><span class="p">(</span><span class="n">Executor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom Executor class for users to tailor to their specific experimental setups.</span>

<span class="sd">    The `CustomExecutor` class is a user-defined extension of the base `Executor` class.</span>
<span class="sd">    Users can customize this class to adapt the optimization and execution process to</span>
<span class="sd">    their specific experimental requirements.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment : Experiment</span>
<span class="sd">        The experiment object associated with the custom executor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CustomExecutor.__init__">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.CustomExecutor.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize `CustomExecutor` object.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span></div>


<div class="viewcode-block" id="CustomExecutor.run">
<a class="viewcode-back" href="../../yotse.html#yotse.execution.CustomExecutor.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">step_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">evolutionary_point_generation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the custom execution process.</span>

<span class="sd">        This method overrides the run method in the base `Executor` class to provide</span>
<span class="sd">        custom logic for the execution process tailored to the user&#39;s specific needs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        step_number : int, optional</span>
<span class="sd">            Step number to submit to QCGPilot. Should be used for e.g. running different optimization steps.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        evolutionary_point_generation : bool, optional</span>
<span class="sd">            Overwrite the type of construction to be used for the new points.</span>
<span class="sd">            If None, the optimization algorithm determines whether the point creation is evolutionary or</span>
<span class="sd">            based on the best solution. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">step_number</span><span class="o">=</span><span class="n">step_number</span><span class="p">,</span>
            <span class="n">evolutionary_point_generation</span><span class="o">=</span><span class="n">evolutionary_point_generation</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, SURFQuantum.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>